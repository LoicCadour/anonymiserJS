<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

</head>
<body>

<input type="file" id="dicomfile" name="files[]" multiple />
<input type="text" id="PatientName" placeholder="Patient Name" />
<input type="date" id="DoB" placeholder="2012-12-25" />


              <div class="row">
                <div class="col-xs-9">
                  <h4><span class="label label-default">JavaScript</span>&nbsp;<span class="label label-default">Html5</span></h4><h4>
                  <small style="font-family:courier,'new courier';" class="text-muted">20th March 2016</small>
                  </h4></div>
                <div class="col-xs-3"></div>
              </div>
              <br><br>
            </div>
          </div>
          <hr>
        </div>
      </div>
                                                                                       
	                                                
                                                      
   	</div><!--/col-12-->
  </div>
</div>
                                                
                                                                                
<hr>

<output id="list"></output>


<script type="text/javascript"
               src="https://raw.githubusercontent.com/chafey/dicomParser/master/dist/dicomParser.min.js"></script>
<script src="FileSaver.min.js"></script>

	<script type="text/javascript">

	//add a handler for reading files from computer
	var dicomFile = document.getElementById('dicomfile');
	dicomFile.onchange = function (evt) {
		var tgt = evt.target || window.event.srcElement;
		var files = tgt.files;
		// FileReader support
		if (FileReader && files && files.length) {
			var fr = new FileReader();
			var extension = files[0].name.split('.').pop().toLowerCase();
			//if extension is not dcm ,then stop processing further and exit.
			//if(extension !== 'dcm') {
				//alert('please choose a Dicom file');
				//return;
			//} else {
				//parse and process the Dicom file.
				fr.onload = function(e) 
				{
					console.debug("Loaded the dicom file");
					var dicomArray = new Uint8Array(e.target.result);
					//parse the Dicom file
					var dataSet = dicomParser.parseDicom(dicomArray);
					
					
					//get width and height of the Dicom image.
					var width = dataSet.uint16('x00280011'), height = dataSet.uint16('x00280010');
					//console.log(dataSet.string('x00100010')); //Get Patient Name

					
					function anonymizetag(tag, text)
					{
						console.log("text length");
						console.log(text.length);
						console.log("element length");
    					var element = dataSet.elements[tag];  
    					console.log(element.length);  					    					
    					if(element){
//!!! size limited to initial size
    						var index = 0;
	        				for (var i = element.dataOffset; i <= element.dataOffset + element.length -1; i++) {
            					dicomArray[i] = text.charCodeAt(index);//toc[index];
            					console.log(text.charCodeAt(index));
            					console.log(text[index]);
            					index++;
            				}
            			}
					}
					
					anonymizetag("x00100010", document.getElementById('PatientName').value);
					anonymizetag("x00100030", document.getElementById('DoB').value);

					
					//SAVING FILE
					var blob = new Blob([dicomArray], {type: "application/octet-stream"});
					var fileName = "bloupi.dcm";
					saveAs(blob, fileName);
				}
				fr.readAsArrayBuffer(this.files[0]);
			//}
		}
	}
	</script>
</body>
</html>

